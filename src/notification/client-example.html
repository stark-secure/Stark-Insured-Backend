<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Client Example</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .notification {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .notification.unread {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .notification.read {
            background: #f5f5f5;
            opacity: 0.7;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button.primary {
            background: #007bff;
            color: white;
        }
        button.secondary {
            background: #6c757d;
            color: white;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Real-time Notification Client</h1>
    
    <div id="status" class="status disconnected">
        Disconnected
    </div>

    <div class="controls">
        <input type="text" id="userId" placeholder="User ID" value="test-user-123">
        <button class="primary" onclick="connect()">Connect</button>
        <button class="secondary" onclick="disconnect()">Disconnect</button>
        <button class="secondary" onclick="markAllAsRead()">Mark All as Read</button>
    </div>

    <div class="controls">
        <h3>Test Notifications</h3>
        <button onclick="testClaimApproved()">Test Claim Approved</button>
        <button onclick="testPolicyCreated()">Test Policy Created</button>
        <button onclick="testPaymentReceived()">Test Payment Received</button>
        <button onclick="testSystemAlert()">Test System Alert</button>
    </div>

    <div id="notifications">
        <h3>Notifications</h3>
        <div id="notificationList"></div>
    </div>

    <script>
        let socket;
        let currentUserId;

        function connect() {
            currentUserId = document.getElementById('userId').value;
            if (!currentUserId) {
                alert('Please enter a User ID');
                return;
            }

            // Connect to the notification namespace
            socket = io('http://localhost:3000/notifications', {
                auth: { userId: currentUserId }
            });

            socket.on('connect', () => {
                updateStatus('Connected', 'connected');
                console.log('Connected to notification server');
                
                // Join the user's notification room
                socket.emit('join', { userId: currentUserId });
            });

            socket.on('disconnect', () => {
                updateStatus('Disconnected', 'disconnected');
                console.log('Disconnected from notification server');
            });

            socket.on('notification', (data) => {
                console.log('Received notification:', data);
                addNotification(data.data);
            });

            socket.on('unreadCount', (data) => {
                console.log('Unread count:', data.count);
                updateUnreadCount(data.count);
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateStatus('Connection Error', 'disconnected');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            updateStatus('Disconnected', 'disconnected');
        }

        function updateStatus(message, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${className}`;
        }

        function addNotification(notification) {
            const notificationList = document.getElementById('notificationList');
            const notificationElement = document.createElement('div');
            notificationElement.className = `notification ${notification.status.toLowerCase()}`;
            notificationElement.innerHTML = `
                <h4>${notification.title}</h4>
                <p>${notification.message}</p>
                <small>Type: ${notification.type} | Status: ${notification.status} | Created: ${new Date(notification.createdAt).toLocaleString()}</small>
                ${notification.status === 'UNREAD' ? `<button onclick="markAsRead('${notification.id}')" style="margin-left: 10px;">Mark as Read</button>` : ''}
            `;
            notificationList.insertBefore(notificationElement, notificationList.firstChild);
        }

        function markAsRead(notificationId) {
            if (socket) {
                socket.emit('markAsRead', { notificationId });
            }
        }

        function markAllAsRead() {
            if (socket && currentUserId) {
                socket.emit('markAllAsRead', { userId: currentUserId });
            }
        }

        function updateUnreadCount(count) {
            // You could update a badge or counter here
            console.log(`Unread notifications: ${count}`);
        }

        // Test notification functions
        async function testClaimApproved() {
            await sendTestNotification({
                userId: currentUserId,
                type: 'CLAIM_APPROVED',
                title: 'Claim Approved',
                message: 'Your claim has been approved and will be processed for payout.'
            });
        }

        async function testPolicyCreated() {
            await sendTestNotification({
                userId: currentUserId,
                type: 'POLICY_CREATED',
                title: 'Policy Created',
                message: 'Your insurance policy has been successfully created and is now active.'
            });
        }

        async function testPaymentReceived() {
            await sendTestNotification({
                userId: currentUserId,
                type: 'PAYMENT_RECEIVED',
                title: 'Payment Received',
                message: 'Payment of 100 ETH has been received and processed successfully.'
            });
        }

        async function testSystemAlert() {
            await sendTestNotification({
                userId: currentUserId,
                type: 'SYSTEM_ALERT',
                title: 'System Maintenance',
                message: 'Scheduled maintenance will begin in 30 minutes. Please save your work.'
            });
        }

        async function sendTestNotification(notificationData) {
            try {
                const response = await fetch('http://localhost:3000/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(notificationData)
                });

                if (response.ok) {
                    console.log('Test notification sent successfully');
                } else {
                    console.error('Failed to send test notification');
                }
            } catch (error) {
                console.error('Error sending test notification:', error);
            }
        }
    </script>
</body>
</html> 